# Order Processor Service Configuration
# Dapr-only architecture: Messaging, secrets, tracing, and service invocation handled by Dapr

spring:
  application:
    name: order-processor-service

  profiles:
    active: ${SPRING_PROFILES_ACTIVE:development}

  # Database configuration - credentials from Dapr secrets
  datasource:
    url: jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5435}/${DB_NAME:order_processor_db}
    username: ${DB_USER:orderprocessoruser}
    password: ${DB_PASSWORD:order_processor_dev_pass_123}
    driver-class-name: org.postgresql.Driver

  jpa:
    open-in-view: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        jdbc:
          batch_size: 25
          batch_versioned_data: true
        order_inserts: true
        order_updates: true

  flyway:
    locations: classpath:db/migration
    enabled: true

  jackson:
    default-property-inclusion: non_null
    serialization:
      write-dates-as-timestamps: false
    deserialization:
      fail-on-unknown-properties: false
    date-format: yyyy-MM-dd'T'HH:mm:ss.SSS'Z'

logging:
  level:
    root: INFO
    com.aioutlet.orderprocessor: INFO
    org.springframework: WARN
    org.hibernate: WARN
    org.flywaydb: INFO

# Actuator endpoints for health checks
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
      base-path: /actuator
  endpoint:
    health:
      show-details: always
      probes:
        enabled: true
  health:
    db:
      enabled: true

# Server configuration
server:
  port: ${SERVER_PORT:1007}
  servlet:
    context-path: /
  error:
    include-message: always
    include-binding-errors: always

# Application metadata
application:
  version: ${APPLICATION_VERSION:1.0.0}

# Dapr configuration
dapr:
  host: ${DAPR_HOST:localhost}
  http-port: ${DAPR_HTTP_PORT:3507}
  grpc-port: ${DAPR_GRPC_PORT:50007}
  app-id: ${DAPR_APP_ID:order-processor-service}
  pubsub-name: ${DAPR_PUBSUB_NAME:event-bus}

# Service invocation via Dapr (app-id based, not URLs)
services:
  order:
    app-id: order-service
  payment:
    app-id: payment-service
  inventory:
    app-id: inventory-service
  shipping:
    app-id: shipping-service

# Pub/Sub topics - centralized configuration
topics:
  order-created: order.created
  order-updated: order.updated
  order-cancelled: order.cancelled
  order-status-changed: order.status.changed
  payment-processed: payment.processed
  payment-failed: payment.failed
  inventory-reserved: inventory.reserved
  inventory-failed: inventory.failed
  shipping-prepared: shipping.prepared
  shipping-failed: shipping.failed

# Saga orchestration configuration
saga:
  retry:
    max-attempts: 3
    backoff-multiplier: 2
    initial-delay-ms: 1000
  timeout:
    payment-seconds: 300
    inventory-seconds: 180
    shipping-seconds: 240
  scheduler:
    stuck-sagas-check-ms: 900000
    retry-sagas-check-ms: 300000
